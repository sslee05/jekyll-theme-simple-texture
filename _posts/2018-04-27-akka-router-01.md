---
layout: post
title: "akka router"
description: "akka router"
categories: [scala-akka]
tags: [scala,스칼라,akka,아카,router,라우터]
redirect_from:
  - /2018/04/27/
---

> akka Router.
>


* Kramdown table of contents
{:toc .toc}

#들어가기에 앞서
모 통신사 프로젝트에 있을때 batch 쪽을 맡아 일을 하고 있었다.  
거기에는 통신사의 전국 대리점들의 실적과 정책들을 계산하여 손익의 결과를 도출하는 batch  
작업이 있다. 평소때는 무리가 없다가 월말이 되면 정말 속터질 정도로 느렸는데, 그때 생각이  
이런 날이면 수직확장이든 수평확장이든 자동 확장하여 처리대상을 평소와 같이 했으면 했었다.  
(물론 spring batch의 partitioning, multi-thread로 구현 했지만 이는 또 다른 이야기 이다.)  
akka를 들고 다시 그때로 간다면...  

# Router
akka 의 router pattern의 주된 목적은 여러 개의 routee(router가 선택할 수 있는 작업actor)들을 두어 성능 향상에 목적을 둔다.  
또한 같은 message를 routee들에 동시에 발송하여 가장 빠른 응답의 경쟁 관계를 통한 것도 있다.  
그리고 메시지의 상태에 따른 routee를 분기할 수 도 있다.  

## akka 내장 router
akka에서 제공하는 내장 router들에는 2가지가 있다.  
### pool router  
router가 routee를 관리 한다. 관리한다는 것은 routee의 life cycle를 관리한다는 것이다.  
그러므로 routee의 부모 actor는 Router이다.  
따라서 구성이 간단하지만 routee가 stop된다면 다시 새로 생성하지 않는다.  
resize기능을 이용하여 이를 우회 할 수 있다  
상세한 routee 생명주기 제어가 필요치 않다면 이를 사용
### group router
routee의 life cycle를 관리하는 actor를 만들고 이를 group actor와 통신하며  
routee를 group actor에게 message를 보내어 추가,삭제 한다.  
따라서 routee의 부모 actor는 router가 아니라 routee의 생성,삭제을 담당하는 actor다.  

## router logic 
akka에서 제공하는 router 방식이 여러가지가 있다. 목록은 akka.io 에서 자세히 보고  
정리 차원에서 나름 나래비를 세워 본다.  
##### RoundRobinRoutingLogic 
 - routee에 순차적으로 message를 보낸다.
 - pool router명 : RoundRobinPool
 - group router명: RoundRobinGroup  

##### ConsistentHashingRoutingLogic
 - 특정 hashing key에 같은 routee에게 message가 분배된다. 주로 key에 따른 message를 취합 시에 적당 한 듯
 - pool router명 : ConsistentHashingPool
 - group router명: ConsistentHashingGroup

##### ScatterGatherFirstCompletedRoutingLogic
 - message를 모든 routee에게 보내고 최초로 응답한 routee의 응답만을 원래 송신자에게 전달 한다. 이는 scatterGather의 경쟁 pattern부분에 적합하다.
 - pool router명 : ScatterGatherFirstCompletedPool
 - group router명: ScatterGatherFirstCompletedGroup

##### SmallestMailboxRoutingLogic
 - routee 중에 mailbox에 가장 적은 message가 있는 routee에게 message를 전달
 - pool router명 : SmallestMailboxPool
 - group router명: 없음

이외에도 여러가지가 있으니 akka.io를 찾아보자.

# Pool router 만들어 보기
우선 local 그러니깐 수직 확장을 해보고, 그 다음 remote원격지에 routee를 가지는 수평확장으로 만들어 보자.
## Pool router의 생성
router의 생성은 설정에 의한 방법과 code에서 하는 방법이 있다.  
### local router
1. 설정 file생성 
아래는 local-pool.conf로 만든 설정 file 
{% highlight scala %}
akka {
  loggers = ["akka.event.slf4j.Slf4jLogger"]
  loglevel = "DEBUG"
  logging-filter = "akka.event.slf4j.Slf4jLoggingFilter"
  actor.deployment {
    /localRouter {
      #router 정책  
      router = round-robin-pool
      #routee 갯수
      nr-of-instances = 2
    }
  }
}
{% endhighlight %}


[^1]: This is a footnote.

[kramdown]: https://kramdown.gettalong.org/
[Simple Texture]: https://github.com/yizeng/jekyll-theme-simple-texture
