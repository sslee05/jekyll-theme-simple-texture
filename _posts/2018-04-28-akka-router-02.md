---
layout: post
title: "akka router 02"
description: "akka router"
categories: [scala-akka]
tags: [scala,스칼라,akka,아카,router,라우터]
redirect_from:
  - /2018/04/27/
---

> akka Router.
>


* Kramdown table of contents
{:toc .toc}

# 들어가기 앞어
저번 post에 router에 대하여 pool, group기반의 생성 및 특징 test를 해보았다.  
이번 post에는 router의 resize 와 routee가 aggregator 특징을 가진 경우, 또 message의 상태에 따라 routee를 분기 해야 하는 겨우를 살펴 보자  

# Resize
일을 처리할 task가 처리할 data의 량에 따라 자동적으로 늘어나고 줄어 들면 일정한 처리 속도를 유지 할 수 있다.  
__resizer의 판단은 router가 routee에 message를 할당하기 전에 resize를 판단한다.__  
pool기반의 resize는 resizer라는 설정으로 routee의 size를 조절 할 수 있다. akka router의 resizer를 살펴 보자.  

## Pool에서의 resize
{% highlight scala %}
...생략
actor.deployment {
/localRouter {
  router = round-robin-pool
  nr-of-instances = 3

  #resize의 판단은 routee에 message를 할당하기 전에 판단한다.
  #resize는 동기적으로 실행 되지 않는다.
  resizer {

    #resizer 기능을 킨다.
    enabled = on

    #routee의 최소 갯수
    lower-bound = 1 

    #routee의 최대 갯수       
    upper-bound = 100 

    #resiz의 발생 기준
    #모든 actor의 mailbox에 message가 1개 있을 경우
    #0 일경우 mailbox에 message 갯수와 상관 없이 모든 routee가 메시지를 처리중 일 경우
    pressure-threshold = 1 

    #size up 변동 크기 갯수 
    #현재 routee의 갯수 * 0.65  = result의 소숫점 첫째자리 올림
    rampup-rate = 0.65

    #언제 routee의 갯수를 줄일 것인가?
    #message를 처리하는 routee의 비율이 0.3 미만일때 resize down
    #현재 전체 routee 갯수 * 0.3 에 대한 미만 일 경우
    backoff-threshold = 0.3

    #size down 변동 크기 갯수
    #rampup-rate 와 개산방식은 동일 하다. 
    backoff-rate = 0.1

    #크기 조정 후 다음 재조정까지 최소 몇 개의 메시지를 받아야 하는지 설정
    #이는 message가 도착할 때마다 크기가 꼐속 늘거나 줄어드는 것을 방지 하기 위함
    messages-per-resize = 1
  }
}
{% endhighlight %}
위의 설정을 보면 최초 routee는 3개이다.  
이는 처음에 routee 3개이다 처음 router가 message를 1개 받아서 routee에 주기 전에 resize를 판단한다. backoff-threadhold를 보면 값은 0.3 * 3 = 0.9 올림한다고 했으니 1 이 것의 의미는 현재 message를 처리하고 있는 routee수의 비율이 1개 미만이면 bacloff-rate 비율만큼 줄이겠다는 의미로 현재는 1개미만 이다. 따라서 1번째 message를 줄때 routee가 2개 된다.  

그리고 나머지 코드를 보고 resize 속성에 따른 결과를 보며 결과를 분석 해보자.  
{% highlight scala %}
class ResizeRouteeActor extends Actor with ActorLogging {
  def receive = {
    case MyMessage(value) =>
      //현재 처리하는 routee를 보기 위해 
      log.debug(s"##### $self $value")
	  
      //기간을 주어 mailbox에 mail을 쌓이게 한다.
	  Thread.sleep(3000L)
      sender ! MyReplyMessage(value)
  }
}
{% endhighlight %}

아래와 같이 (여기서는 그냥 App로 )test할 App file를 만들고 결과를 보자  
{% highlight scala %}
object ResizerApp extends App {
  
  import com.sslee.pool.routemessges._
  
  val system = ActorSystem("resizeActorSystem", ConfigFactory.load("local-pool-resizer"))
  
  val router =
  	system.actorOf(FromConfig.props(Props[ResizeRouteeActor]),"localRouter")
  val senderActor = system.actorOf(Props(new SenderActor(router)))
  
  //모든 routeee mailbox 에 message가 들어 가도록 한다.
  senderActor ! MyMessage(s"message 0")
  senderActor ! MyMessage(s"message 1")
  senderActor ! MyMessage(s"message 2")
  
  //messages-per-resize = 1 로 설정 했으므로 
  // 이번 message들 때는 판단을 유보 한다. 
  // 이번 message들은 모두 2개의  routee mail box로 간다.,
  // 그 후 부터는 message들은 다시 resize 판단의 기준다.
  (0 to 8) foreach { i =>
    senderActor ! MyMessage(s"overload message $i")
  }
  
  //resize는 동기적으로 일어나지 않기 때문에  reoutee를 추가하기전에 routee가 먼저 일을 끝낼 수 있다.
  //따라서 시간을 두어 모든 message가 현재 2개의 routee mail box로 모두 들어가지 않게 한다.
  //설정에 router가 routee message를 주기 전에 
  //현재 모든 routee들의 mail box가 message1개 있을 경우에 size up이 발생한다. 
  Thread.sleep(1000L)
  (0 to 8) foreach { i =>
    senderActor ! MyMessage(s"overload message $i$i")
  }
  
  println("send end")
  
}
{% endhighlight %}  

결과는 아래와 같이 알아보기 쉽게 편집 했음  
{% highlight scala %}
$b#1295478387] message 1
$a#264400209]  message 0
$d#2046181299] overload message 22
$e#435088530] overload message 33
$a#264400209] message 2
$b#1295478387] overload message 0
$d#2046181299] overload message 66

...중략 
{% endhighlight %}
시작하자 마자 backoff-threadhold 때문에  3개에서 2로 시작됨을 알수 있다. 왜냐면 roundrobin  방색이므로 routee가 3개로 시작했다면 message0,1,2 를 a,b,c 3개가 되어야 하는데 위에 결과를 보면 2개의 routee가 모든 메시지를 처리 함을 볼 수 있다.  
또한 overload message $i$i 는 (messages-per-resize = 1)의 설정에 따라 overload message $i 가 지난 후 resize이 되어 rampup-rate = 0.65 즉 2 * 0.65 = 1.3 => 2(올림) 이되어 $d#2046181299] overload message 22  와 $e#435088530] overload message 33 을 볼 수 있다.  

# group router resize
group

[^1]: This is a footnote.

[kramdown]: https://kramdown.gettalong.org/
[Simple Texture]: https://github.com/yizeng/jekyll-theme-simple-texture
